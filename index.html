<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ ¡é–²Pro v15</title>
    <style>
        :root {
            --bg-color: #f0f2f5; --container-bg: #ffffff; --text-color: #1c1e21; --border-color: #dddfe2;
            --accent-blue: #1877f2; --accent-green: #42b72a; --accent-purple: #8e44ad; --accent-red: #fa3e3e;
            --config-bg: #fff9db; --list-bg: #e7f3ff; --opt-bg: #f5f6f7; --replace-bg: #ebfbee;
        }
        body.dark-mode {
            --bg-color: #18191a; --container-bg: #242526; --text-color: #e4e6eb; --border-color: #3e4042;
            --accent-blue: #4599ff; --config-bg: #3a3b3c; --list-bg: #263951; --opt-bg: #303031; --replace-bg: #2d3d2d;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 1100px; margin: 20px auto; padding: 0 20px; background-color: var(--bg-color); color: var(--text-color); transition: 0.3s; line-height: 1.5; }
        .container { background: var(--container-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        h1 { font-size: 1.4rem; border-left: 6px solid var(--accent-blue); padding-left: 15px; margin: 0 0 20px 0; }
        
        textarea { width: 100%; height: 200px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 14px; background: var(--container-bg); color: var(--text-color); font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; }
        details { background: var(--opt-bg); border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        details summary { padding: 10px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        .details-content { padding: 15px; border-top: 1px solid var(--border-color); }

        .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; font-size: 0.8rem; }
        .opt-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .opt-item select { font-size: 0.75rem; padding: 2px 5px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--container-bg); color: var(--text-color); }

        .list-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .list-box { padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); }
        .list-box label { font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px; }

        /* æ“ä½œç³» */
        .controls { background: var(--opt-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; border: 1px solid var(--border-color); }
        .style-select { font-weight: bold; padding: 8px; border-radius: 6px; border: 2px solid var(--accent-blue); background: var(--container-bg); color: var(--text-color); }
        
        /* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ */
        .compare-mode { display: flex; align-items: center; gap: 5px; font-weight: bold; color: var(--accent-purple); cursor: pointer; transition: 0.3s; }
        .compare-mode.disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }

        .button-main { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; color: white; }
        button:hover { opacity: 0.85; transform: translateY(-1px); }
        .btn-exec { background: var(--accent-blue); font-size: 1rem; }
        .btn-copy { background: #17a2b8; }
        .btn-save { background: var(--accent-green); }
        .btn-sync { background: var(--accent-purple); font-size: 11px; padding: 5px 10px; width: 100%; margin-top: 5px; }
        .btn-clear { background: var(--accent-red); font-size: 11px; }

        #output { background: var(--container-bg); padding: 20px; border: 2px solid var(--border-color); border-radius: 8px; white-space: pre-wrap; min-height: 250px; font-size: 15px; line-height: 1.6; }
        .diff-tag { color: #d63384; font-weight: bold; background: #fff0f6; border-radius: 3px; padding: 0 2px; }
        body.dark-mode .diff-tag { color: #ff7eb9; background: #4b2d39; }
        .counter-badge { font-size: 0.75rem; background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 10px; }
    </style>
</head>
<body class="light-mode">

<div class="container">
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px;">
        <button class="btn-mode" onclick="toggleDarkMode()" id="modeBtn" style="color:white; background:#666; font-size:11px; padding:5px 10px;">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
    
    <h1>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ ¡é–²Pro v15</h1>

    <details>
        <summary>ğŸ”§ ãƒãƒ¼ãƒ åŒæœŸãƒ»åŸºæœ¬è¨­å®š</summary>
        <div class="details-content" style="font-size: 0.8rem; background: var(--config-bg);">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div>GitHubãƒˆãƒ¼ã‚¯ãƒ³: <input type="password" id="githubToken" oninput="saveSettings()" style="width:100%;"></div>
                <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <input type="text" id="githubUser" oninput="saveSettings()" value="sakumaaaaa" style="width:100%;"></div>
                <div>ãƒªãƒã‚¸ãƒˆãƒª: <input type="text" id="githubRepo" oninput="saveSettings()" value="text-formatting-tool" style="width:100%;"></div>
            </div>
        </div>
    </details>

    <details>
        <summary>ğŸ”¡ è¨˜å·ã®å…¨è§’ãƒ»åŠè§’ã‚ªãƒ—ã‚·ãƒ§ãƒ³</summary>
        <div class="details-content options-grid" id="optionsGrid">
            <div class="opt-item"><span>ï¼… ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ</span><select id="opt_percent"><option value="zen">å…¨è§’ ï¼…</option><option value="han">åŠè§’ %</option></select></div>
            <div class="opt-item"><span>ï¼† ã‚¢ãƒ³ãƒ‘ã‚µãƒ³ãƒ‰</span><select id="opt_ampersand"><option value="zen">å…¨è§’ ï¼†</option><option value="han">åŠè§’ &</option></select></div>
            <div class="opt-item"><span>ï¼ˆ ï¼‰ã‚«ãƒƒã‚³</span><select id="opt_bracket"><option value="zen">å…¨è§’ ï¼ˆ ï¼‰</option><option value="han">åŠè§’ ( )</option></select></div>
            <div class="opt-item"><span>ï¼š ã‚³ãƒ­ãƒ³</span><select id="opt_colon"><option value="zen">å…¨è§’ ï¼š</option><option value="han">åŠè§’ :</option></select></div>
            <div class="opt-item"><span>èª­ç‚¹ ãƒ†ãƒ³</span><select id="opt_comma"><option value="ten">ãƒ†ãƒ³ ã€</option><option value="comma">ã‚«ãƒ³ãƒ ï¼Œ</option></select></div>
            <div class="opt-item"><span>å¼•ç”¨ç¬¦ ""</span><select id="opt_quote"><option value="zen">å…¨è§’ â€œâ€</option><option value="han">åŠè§’ ""</option></select></div>
            <div class="opt-item"><span>ï¼ ï¼Ÿ æ„Ÿå˜†ç–‘å•</span><select id="opt_mark"><option value="zen">å…¨è§’ ï¼ ï¼Ÿ</option><option value="han">åŠè§’ ! ?</option></select></div>
            <div class="opt-item"><span>â€• ãƒ€ãƒ¼ã‚·</span><select id="opt_dash"><option value="zen">å…¨è§’ â€•</option><option value="han">åŠè§’ -</option></select></div>
            <div class="opt-item"><span>- ãƒã‚¤ãƒ•ãƒ³</span><select id="opt_hyphen"><option value="han">åŠè§’ -</option><option value="zen">å…¨è§’ ï¼</option></select></div>
            <div class="opt-item"><span>ï¼ ã‚¹ãƒ©ãƒƒã‚·ãƒ¥</span><select id="opt_slash"><option value="han">åŠè§’ /</option><option value="zen">å…¨è§’ ï¼</option></select></div>
            <div class="opt-item"><span>ï¼ ç­‰å·ä¸ç­‰å·</span><select id="opt_equal"><option value="han">åŠè§’ = < ></option><option value="zen">å…¨è§’ ï¼ ï¼ ï¼œ</option></select></div>
            <div class="opt-item"><span>ï¼‹ ãƒ—ãƒ©ã‚¹</span><select id="opt_plus"><option value="han">åŠè§’ +</option><option value="zen">å…¨è§’ ï¼‹</option></select></div>
        </div>
    </details>

    <details id="listDetails">
        <summary>ğŸ“š é™¤å¤–ãƒ»ç½®æ›ãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</summary>
        <div class="details-content list-grid">
            <div class="list-box" style="background:var(--list-bg)">
                <label>1. é™¤å¤–ãƒªã‚¹ãƒˆ (common_list.txt)</label>
                <textarea id="whitelist" style="height: 100px;"></textarea>
                <button class="btn-sync" onclick="syncList('common_list.txt', 'whitelist')">â˜ï¸ åŒæœŸ</button>
            </div>
            <div class="list-box" style="background:var(--replace-bg)">
                <label>2. ç”¨èªçµ±ä¸€ (replace_list.txt)</label>
                <textarea id="replaceList" style="height: 100px;" placeholder="ã‚¦ã‚§ãƒãƒ¼ > ã‚¦ã‚¨ãƒ"></textarea>
                <button class="btn-sync" onclick="syncList('replace_list.txt', 'replaceList')">â˜ï¸ åŒæœŸ</button>
            </div>
            <div class="list-box" style="background:#fff3e0">
                <label>3. ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© (presets.json)</label>
                <textarea id="presetsJson" style="height: 100px;" placeholder='{"ã‚µã‚¤ã‚¨ãƒ³ã‚¹": {"Apple": "ã‚¢ãƒƒãƒ—ãƒ«ç¤¾"}}'></textarea>
                <button class="btn-sync" onclick="syncList('presets.json', 'presetsJson')">â˜ï¸ åŒæœŸ</button>
            </div>
        </div>
    </details>

    <!-- ãƒ¡ã‚¤ãƒ³æ“ä½œ -->
    <div class="controls">
        <div>
            æ ¡é–²ã‚¹ã‚¿ã‚¤ãƒ«: 
            <select id="activeStyle" class="style-select" onchange="handleStyleChange()">
                <option value="none">ãªã— (æ•´å½¢ã®ã¿)</option>
                <option value="æ±ç”¨ï¼ˆè‹±åï¼‰">æ±ç”¨ï¼ˆè‹±åï¼‰</option>
                <option value="æ±ç”¨ï¼ˆå’Œåï¼‰">æ±ç”¨ï¼ˆå’Œåï¼‰</option>
                <option value="ã‚µã‚¤ã‚¨ãƒ³ã‚¹">ã‚µã‚¤ã‚¨ãƒ³ã‚¹</option>
                <option value="å¤§å±±ãƒ¬ãƒãƒ¼ãƒˆ">å¤§å±±ãƒ¬ãƒãƒ¼ãƒˆ</option>
            </select>
        </div>
        <label id="compareLabel" class="compare-mode disabled">
            <input type="checkbox" id="compareMode" disabled> æ¯”è¼ƒãƒ»æ³¨é‡ˆãƒ¢ãƒ¼ãƒ‰ (åŸæ–‡ã€>ä¿®æ­£ã€‘)
        </label>
    </div>

    <div class="label-row">â‘  åŸæ–‡ã‚’è²¼ã‚Šä»˜ã‘</div>
    <textarea id="input" placeholder="PDFç­‰ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«..."></textarea>
    
    <div class="button-main">
        <button class="btn-exec" onclick="processText()">âœ¨ æ•´å½¢ãƒ»æ ¡é–²ã‚’å®Ÿè¡Œ</button>
        <button class="btn-copy" onclick="copyToClipboard()">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn-save" onclick="downloadTxt()">ğŸ’¾ .txtã§ä¿å­˜</button>
    </div>

    <div class="label-row">
        <span>â‘¡ æ•´å½¢ãƒ»æ ¡é–²çµæœ</span>
        <span id="charCount" class="counter-badge">æ–‡å­—æ•°: 0 | å…¨è§’æ›ç®—: 0</span>
    </div>
    <div id="output"></div>
</div>

<script>
    const OPT_KEYS = ['opt_percent','opt_ampersand','opt_bracket','opt_colon','opt_comma','opt_quote','opt_mark','opt_dash','opt_hyphen','opt_slash','opt_equal','opt_plus'];

    window.onload = function() {
        document.getElementById('githubToken').value = localStorage.getItem('gh_token') || '';
        if(localStorage.getItem('gh_user')) document.getElementById('githubUser').value = localStorage.getItem('gh_user');
        if(localStorage.getItem('gh_repo')) document.getElementById('githubRepo').value = localStorage.getItem('gh_repo');
        OPT_KEYS.forEach(id => {
            const val = localStorage.getItem(id);
            if(val) document.getElementById(id).value = val;
            document.getElementById(id).addEventListener('change', saveSettings);
        });
        if(localStorage.getItem('theme') === 'dark') toggleDarkMode();
        handleStyleChange(); // åˆæœŸçŠ¶æ…‹ã®UIæ›´æ–°
    };

    // ã‚¹ã‚¿ã‚¤ãƒ«ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸæ™‚ã®UIåˆ¶å¾¡
    function handleStyleChange() {
        const style = document.getElementById('activeStyle').value;
        const checkbox = document.getElementById('compareMode');
        const label = document.getElementById('compareLabel');

        if (style === 'none') {
            checkbox.disabled = true;
            checkbox.checked = false; // æ•´å½¢ã®ã¿ã®æ™‚ã¯æ³¨é‡ˆã‚’å‡ºã•ãªã„
            label.classList.add('disabled');
        } else {
            checkbox.disabled = false;
            // å‰å›ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’æ€ã„å‡ºã™ãªã©ã®å‡¦ç†ã‚‚å¯èƒ½ã§ã™ãŒã€ä¸€æ—¦æœ‰åŠ¹åŒ–ã®ã¿
            label.classList.remove('disabled');
        }
    }

    function saveSettings() {
        localStorage.setItem('gh_token', document.getElementById('githubToken').value);
        localStorage.setItem('gh_user', document.getElementById('githubUser').value);
        localStorage.setItem('gh_repo', document.getElementById('githubRepo').value);
        OPT_KEYS.forEach(id => localStorage.setItem(id, document.getElementById(id).value));
    }

    function toggleDarkMode() {
        const body = document.body; body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('modeBtn').innerText = isDark ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
    }

    function clearAll() { if(confirm("å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { document.getElementById('input').value = ""; document.getElementById('output').innerText = ""; } }

    function copyToClipboard() {
        const text = document.getElementById('output').innerText;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
    }

    async function syncList(fileName, elementId) {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        const textArea = document.getElementById(elementId);
        if(!token || !user || !repo) { alert("åŒæœŸè¨­å®šï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ç­‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        const url = `https://api.github.com/repos/${user}/${repo}/contents/${fileName}`;
        try {
            const res = await fetch(url, { headers: { "Authorization": `token ${token}` }, cache: "no-store" });
            if (res.ok) {
                const data = await res.json();
                const remote = decodeURIComponent(escape(atob(data.content)));
                if (textArea.value.trim() !== "" && textArea.value.trim() !== remote.trim()) {
                    if (confirm(`${fileName} ã‚’GitHubã«ä¿å­˜(ä¸Šæ›¸ã)ã—ã¾ã™ã‹ï¼Ÿ\n(ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨èª­ã¿è¾¼ã¿ã¾ã™)`)) {
                        const putRes = await fetch(url, {
                            method: "PUT", headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                            body: JSON.stringify({ message: `Update ${fileName}`, content: btoa(unescape(encodeURIComponent(textArea.value))), sha: data.sha })
                        });
                        if(putRes.ok) alert("GitHubã¸ä¿å­˜ã—ã¾ã—ãŸ");
                        return;
                    }
                }
                textArea.value = remote; alert(`${fileName} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } else { alert("ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); }
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    function processText() {
        let text = document.getElementById('input').value;
        const isCompare = document.getElementById('compareMode').checked;
        const activeStyle = document.getElementById('activeStyle').value;
        
        text = text.replace(/\r\n/g, '\n').replace(/[\t\u00A0]/g, ' ').replace(/[ ã€€]+\n/g, '\n');

        const protectedItems = [];
        text = text.replace(/https?:\/\/[\w!\?\/+\-_~=;\.,\*&@#\$%\(\)'\[\]]+/g, (m) => {
            const p = `__URL${protectedItems.length}__`; protectedItems.push({p, original: m}); return p;
        });
        text = text.replace(/\d{1,2}:\d (?:[0-9]{1,2})/g, (m) => { // æ™‚åˆ»ä¿è­·ã‚’å¾®èª¿æ•´
             const p = `__TIME${protectedItems.length}__`; protectedItems.push({p, original: m}); return p;
        });

        text = text.replace(/\n\s*ã€€/g, '___ZEN_PARA___').replace(/\n\n+/g, '___DBL_PARA___');

        const config = {}; OPT_KEYS.forEach(id => config[id] = document.getElementById(id).value);
        text = text.replace(/[ï¼…%]/g, config.opt_percent === 'zen' ? 'ï¼…' : '%');
        text = text.replace(/[ï¼†&]/g, config.opt_ampersand === 'zen' ? 'ï¼†' : '&');
        text = text.replace(/[ï¼!]/g, config.opt_mark === 'zen' ? 'ï¼' : '!');
        text = text.replace(/[ï¼Ÿ?]/g, config.opt_mark === 'zen' ? 'ï¼Ÿ' : '?');
        text = text.replace(/[ï¼š:]/g, config.opt_colon === 'zen' ? ' ï¼š' : ':');
        if (config.opt_bracket === 'zen') text = text.replace(/[\(\)]/g, s => s === '(' ? 'ï¼ˆ' : 'ï¼‰');
        else text = text.replace(/[ï¼ˆï¼‰]/g, s => s === 'ï¼ˆ' ? '(' : ')');
        if (config.opt_comma === 'comma') text = text.replace(/ã€/g, 'ï¼Œ');
        else text = text.replace(/ï¼Œ/g, 'ã€');
        if (config.opt_quote === 'zen') text = text.replace(/"([^"]*)"/g, 'â€œ$1â€');
        else text = text.replace(/[â€œâ€]/g, '"');
        text = text.replace(/[â€•â€”]/g, config.opt_dash === 'zen' ? 'â€•' : '-').replace(/[ï¼-]/g, config.opt_hyphen === 'zen' ? 'ï¼' : '-');
        text = text.replace(/[ï¼/]/g, config.opt_slash === 'zen' ? 'ï¼' : '/').replace(/[ï¼=]/g, config.opt_equal === 'zen' ? 'ï¼' : '=');
        text = text.replace(/[ï¼‹+]/g, config.opt_plus === 'zen' ? 'ï¼‹' : '+');
        text = text.replace(/ï¼/g, '.').replace(/\uFF5E/g, '\u301C').replace(/[ï½¥ãƒ»]/g, 'ãƒ»');
        text = text.replace(/[ï¼-ï¼™ï½-ï½šï¼¡-ï¼º]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));

        text = text.replace(/\n/g, '');

        // --- æ ¡é–²ã‚¹ã‚¿ã‚¤ãƒ«ãŒ "none" ã®å ´åˆã¯ç½®æ›ã‚’ä¸€åˆ‡è¡Œã‚ãªã„ ---
        if (activeStyle !== 'none') {
            let replaceRules = [];
            try {
                const presets = JSON.parse(document.getElementById('presetsJson').value || '{}');
                if (presets[activeStyle]) {
                    for (let key in presets[activeStyle]) {
                        replaceRules.push({ from: key, to: presets[activeStyle][key] });
                    }
                }
            } catch(e) { console.error("JSON error"); }

            const manualReplace = document.getElementById('replaceList').value.split('\n');
            manualReplace.forEach(line => {
                const parts = line.split('>');
                if (parts.length === 2) replaceRules.push({ from: parts[0].trim(), to: parts[1].trim() });
            });

            replaceRules.sort((a, b) => b.from.length - a.from.length);
            const occurrenceMap = new Map();
            
            replaceRules.forEach(rule => {
                if (!rule.from) return;
                const prefixRegex = new RegExp(`[ç±³ç‹¬ä»æ—¥è‹±éŸ“ä¸­]*${rule.from.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}`, 'g');
                text = text.replace(prefixRegex, (match) => {
                    const count = (occurrenceMap.get(rule.from) || 0) + 1;
                    occurrenceMap.set(rule.from, count);
                    let targetTo = rule.to;
                    if (rule.to.includes('|')) {
                        const parts = rule.to.split('|').map(s => s.trim());
                        targetTo = (count === 1) ? parts[0] : parts[1];
                    }
                    if (match === targetTo) return match;
                    return isCompare ? `${match}ã€>${targetTo}ã€‘` : targetTo;
                });
            });
        }

        let prev;
        do {
            prev = text;
            text = text.replace(/([a-zA-Z0-9.])\s+([a-zA-Z0-9.])/g, (match, p1, p2) => {
                return (p1.length === 1 || p2.length === 1) ? p1 + p2 : p1 + " " + p2;
            });
        } while (prev !== text);

        text = text.replace(/([^\x00-\x7F]) +/g, '$1').replace(/ +([^\x00-\x7F])/g, '$1').replace(/([ã€ã€‚ï¼Œ]) +/g, '$1');
        text = text.split('___ZEN_PARA___').join('\n\nã€€').split('___DBL_PARA___').join('\n\n');

        protectedItems.forEach(item => { text = text.split(item.p).join(item.original); });

        const whitelist = document.getElementById('whitelist').value.split(',').map(s => s.trim()).filter(s => s !== "");
        whitelist.forEach(word => {
            const combined = word.replace(/\s+/g, '');
            const escaped = combined.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            text = text.replace(new RegExp(escaped, 'gi'), word);
        });

        text = text.replace(/\n{3,}/g, '\n\n');
        const final = text.trim();
        
        if (isCompare) {
            document.getElementById('output').innerHTML = final.replace(/ã€>(.*?)ã€‘/g, '<span class="diff-tag">ã€&gt;$1ã€‘</span>');
        } else {
            document.getElementById('output').innerText = final;
        }

        let zenkakuCount = 0;
        for (let i = 0; i < final.length; i++) {
            const c = final.charCodeAt(i);
            if ((c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c <= 0xff9f)) zenkakuCount += 0.5;
            else zenkakuCount += 1;
        }
        document.getElementById('charCount').innerText = `æ–‡å­—æ•°: ${final.length} | å…¨è§’æ›ç®—: ${Math.ceil(zenkakuCount)}`;
    }

    function downloadTxt() {
        const text = document.getElementById('output').innerText;
        if (!text) return;
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'cleaned_text.txt';
        a.click();
    }
</script>
</body>
</html>