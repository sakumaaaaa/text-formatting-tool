<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ ¡é–²Pro v28</title>
    <style>
        :root {
            --bg-color: #f0f2f5; --container-bg: #ffffff; --text-color: #1c1e21; --border-color: #dddfe2;
            --accent-blue: #1877f2; --accent-green: #42b72a; --accent-purple: #8e44ad; --accent-red: #fa3e3e; --accent-orange: #f39c12;
            --config-bg: #fff9db; --list-bg: #e7f3ff; --opt-bg: #f5f6f7; --replace-bg: #ebfbee; --presets-bg: #fff3e0;
        }
        body.dark-mode {
            --bg-color: #18191a; --container-bg: #242526; --text-color: #e4e6eb; --border-color: #3e4042;
            --accent-blue: #4599ff; --config-bg: #3a3b3c; --list-bg: #1c2d3d; --opt-bg: #303031; --replace-bg: #1d331d; --presets-bg: #3a2e22;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 1100px; margin: 20px auto; padding: 0 20px; background-color: var(--bg-color); color: var(--text-color); transition: 0.3s; line-height: 1.5; }
        .container { background: var(--container-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        h1 { font-size: 1.4rem; border-left: 6px solid var(--accent-blue); padding-left: 15px; margin: 0 0 20px 0; }
        h2 { font-size: 1.1rem; margin: 25px 0 10px 0; font-weight: bold; border-bottom: 2px solid var(--accent-blue); padding-bottom: 5px; display: block; }

        textarea { width: 100%; height: 200px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 14px; background: var(--container-bg); color: var(--text-color); font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; }
        details { background: var(--opt-bg); border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        details summary { padding: 10px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        .details-content { padding: 15px; border-top: 1px solid var(--border-color); }

        .list-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; }
        .list-box { padding: 12px; border-radius: 6px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 8px; }
        .list-box label { font-size: 0.8rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .list-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .status-init { background: #e9ecef; color: #6c757d; }
        .status-sync { background: #d4edda; color: #155724; }
        .status-unsaved { background: #fff3cd; color: #856404; border: 1px solid var(--accent-orange); }

        .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; font-size: 0.8rem; }
        .opt-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .opt-item select { font-size: 0.75rem; padding: 2px 5px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--container-bg); color: var(--text-color); }

        .controls { background: var(--opt-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; border: 1px solid var(--border-color); }
        .button-main { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; color: white; }
        button:hover { opacity: 0.85; transform: translateY(-1px); }
        .btn-exec { background: var(--accent-blue); font-size: 1rem; }
        .btn-copy { background: #17a2b8; }
        .btn-save { background: var(--accent-green); }
        .btn-sync { background: var(--accent-purple); font-size: 11px; padding: 6px; width: 100%; }
        .btn-assist { background: #e67e22; font-size: 11px; padding: 6px; width: 100%; }

        #output { background: var(--container-bg); padding: 20px; border: 2px solid var(--border-color); border-radius: 8px; white-space: pre-wrap; min-height: 250px; font-size: 15px; line-height: 1.6; }
        .diff-tag { color: #d63384; font-weight: bold; background: #fff0f6; border-radius: 3px; padding: 0 2px; }
        body.dark-mode .diff-tag { color: #ff7eb9; background: #4b2d39; }
        .counter-badge { font-size: 0.75rem; background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 10px; }
    </style>
</head>
<body class="light-mode">

<div class="container">
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px;">
        <button onclick="toggleDarkMode()" id="modeBtn" style="background:#666; font-size:11px; padding:5px 10px; color:white; border-radius:4px; cursor:pointer; border:none;">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
        <button onclick="if(confirm('å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){document.getElementById('input').value='';document.getElementById('output').innerText='';}" style="background:var(--accent-red); font-size:11px; padding:5px 10px; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
    
    <h1>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ ¡é–²Pro v28</h1>

    <!-- åŸºæœ¬è¨­å®š -->
    <details>
        <summary>ğŸ”§ ãƒãƒ¼ãƒ åŒæœŸãƒ»åŸºæœ¬è¨­å®š</summary>
        <div class="details-content" style="font-size: 0.8rem; background: var(--config-bg); display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div>ãƒˆãƒ¼ã‚¯ãƒ³: <input type="password" id="githubToken" oninput="saveSettings()" style="width:100%;"></div>
            <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼: <input type="text" id="githubUser" oninput="saveSettings()" value="sakumaaaaa" style="width:100%;"></div>
            <div>ãƒªãƒã‚¸ãƒˆãƒª: <input type="text" id="githubRepo" oninput="saveSettings()" value="text-formatting-tool" style="width:100%;"></div>
        </div>
    </details>

    <!-- ãƒªã‚¹ãƒˆç®¡ç† -->
    <details id="listDetails">
        <summary>ğŸ“š å„ç¨®ãƒªã‚¹ãƒˆã®åŒæœŸãƒ»ç®¡ç†</summary>
        <div class="details-content list-grid">
            <div class="list-box" style="background:var(--list-bg)">
                <label><span>1. ä¿è­·ãƒªã‚¹ãƒˆ (è¡¨è¨˜ã‚’ç¶­æŒ)</span><span id="status_whitelist" class="list-status status-init">â˜ï¸ æœªèª­è¾¼</span></label>
                <input type="text" id="search_whitelist" style="padding:4px; font-size:0.8rem;" placeholder="ä¿è­·èªã‚’æ¤œç´¢..." oninput="filterList()">
                <textarea id="whitelist" style="height: 120px;" oninput="onListInput()"></textarea>
                <button class="btn-sync" onclick="syncList('common_list.txt', 'whitelist')">â˜ï¸ åŒæœŸï¼ˆA-Zã‚½ãƒ¼ãƒˆï¼‰</button>
            </div>
            <div class="list-box" style="background:var(--replace-bg)">
                <label><span>2. å…±é€šãƒã‚¹ã‚¿ç½®æ›</span><span id="status_replaceList" class="list-status status-init">â˜ï¸ æœªèª­è¾¼</span></label>
                <textarea id="replaceList" style="height: 120px;" oninput="checkUnsaved('replaceList')" placeholder="A, B > C"></textarea>
                <button class="btn-assist" onclick="suggestRules()">ğŸ“‹ æ•´å½¢çµæœã‹ã‚‰ç½®æ›æ¡ˆã‚’æŠ½å‡º</button>
                <div id="assistPanel" class="assist-panel">
                    <div class="assist-title">ğŸ” ç½®æ›æ¡ˆï¼ˆãƒã‚§ãƒƒã‚¯ã—ãŸã‚‚ã®ã‚’è¿½åŠ ï¼‰</div>
                    <div id="assistList" class="assist-list"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="applySuggestions()" style="background:var(--accent-green); font-size:10px; padding:5px;">âœ… è¿½åŠ </button>
                        <button onclick="document.getElementById('assistPanel').style.display='none'" style="background:#999; font-size:10px; padding:5px;">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
                <button class="btn-sync" onclick="syncList('replace_list.txt', 'replaceList')">â˜ï¸ åŒæœŸï¼ˆã‚½ãƒ¼ãƒˆï¼‰</button>
            </div>
            <div class="list-box" style="background:var(--presets-bg)">
                <label><span>3. ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© (JSON)</span><span id="status_presetsJson" class="list-status status-init">â˜ï¸ æœªèª­è¾¼</span></label>
                <textarea id="presetsJson" style="height: 184px;" oninput="checkUnsaved('presetsJson')"></textarea>
                <button class="btn-sync" onclick="syncList('presets.json', 'presetsJson')">â˜ï¸ åŒæœŸ</button>
            </div>
        </div>
    </details>

    <!-- è¨˜å·ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
    <details>
        <summary>ğŸ”¡ è¨˜å·ãƒ»çµ„ç‰ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³</summary>
        <div class="details-content options-grid" id="optionsGrid">
            <div class="opt-item"><span>ï¼… ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ</span><select id="opt_percent"><option value="zen">å…¨è§’ ï¼…</option><option value="han">åŠè§’ %</option></select></div>
            <div class="opt-item"><span>ï¼† ã‚¢ãƒ³ãƒ‘ã‚µãƒ³ãƒ‰</span><select id="opt_ampersand"><option value="zen">å…¨è§’ ï¼†</option><option value="han">åŠè§’ &</option></select></div>
            <div class="opt-item"><span>ï¼ˆ ï¼‰ã‚«ãƒƒã‚³</span><select id="opt_bracket"><option value="zen">å…¨è§’ ï¼ˆ ï¼‰</option><option value="han">åŠè§’ ( )</option></select></div>
            <div class="opt-item"><span>ï¼š ã‚³ãƒ­ãƒ³</span><select id="opt_colon"><option value="zen">å…¨è§’ ï¼š</option><option value="han">åŠè§’ :</option></select></div>
            <div class="opt-item"><span>èª­ç‚¹</span><select id="opt_comma"><option value="ten">ãƒ†ãƒ³ ã€</option><option value="comma">ã‚«ãƒ³ãƒ ï¼Œ</option></select></div>
            <div class="opt-item"><span>å¼•ç”¨ç¬¦</span><select id="opt_quote"><option value="zen">å…¨è§’ â€œâ€</option><option value="han">åŠè§’ ""</option></select></div>
            <div class="opt-item"><span>â€• ãƒ€ãƒ¼ã‚·</span><select id="opt_dash"><option value="zen">å…¨è§’ â€•</option><option value="han">åŠè§’ -</option></select></div>
            <div class="opt-item"><span>- ãƒã‚¤ãƒ•ãƒ³</span><select id="opt_hyphen"><option value="han">åŠè§’ -</option><option value="zen">å…¨è§’ ï¼</option></select></div>
            <div class="opt-item"><span>ï¼ ã‚¹ãƒ©ãƒƒã‚·ãƒ¥</span><select id="opt_slash"><option value="han">åŠè§’ /</option><option value="zen">å…¨è§’ ï¼</option></select></div>
            <div class="opt-item"><span>ï¼ ç­‰å·</span><select id="opt_equal"><option value="han">åŠè§’ =</option><option value="zen">å…¨è§’ ï¼</option></select></div>
            <div class="opt-item"><span>ï¼ ï¼Ÿ æ„Ÿå˜†ç–‘å•</span><select id="opt_mark"><option value="zen">å…¨è§’ ï¼ ï¼Ÿ</option><option value="han">åŠè§’ ! ?</option></select></div>
            <div class="opt-item"><span>ï¼ ï¼Ÿ å¾Œã®ç©ºã</span><select id="opt_mark_space"><option value="keep">ç¶­æŒ</option><option value="force">å…¨è§’ã‚¢ã‚­å¼·åˆ¶</option><option value="none">è©°ã‚ã‚‹</option></select></div>
        </div>
    </details>

    <div class="controls">
        <div>ã‚¹ã‚¿ã‚¤ãƒ«: <select id="activeStyle" class="style-select"><option value="none">ãªã— (æ•´å½¢ã®ã¿)</option><option value="æ±ç”¨ï¼ˆè‹±åï¼‰">æ±ç”¨ï¼ˆè‹±åï¼‰</option><option value="æ±ç”¨ï¼ˆå’Œåï¼‰">æ±ç”¨ï¼ˆå’Œåï¼‰</option><option value="ã‚µã‚¤ã‚¨ãƒ³ã‚¹">ã‚µã‚¤ã‚¨ãƒ³ã‚¹</option><option value="å¤§å±±ãƒ¬ãƒãƒ¼ãƒˆ">å¤§å±±ãƒ¬ãƒãƒ¼ãƒˆ</option></select></div>
        <label class="compare-mode"><input type="checkbox" id="compareMode" checked> æ¯”è¼ƒãƒ»æ³¨é‡ˆãƒ¢ãƒ¼ãƒ‰</label>
    </div>

    <h2>â‘  åŸæ–‡ã‚’è²¼ã‚Šä»˜ã‘</h2>
    <textarea id="input" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
    
    <div class="button-main">
        <button class="btn-exec" onclick="processText()">âœ¨ æ•´å½¢ãƒ»æ ¡é–²ã‚’å®Ÿè¡Œ</button>
        <button class="btn-copy" onclick="copyToClipboard()">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn-save" onclick="downloadTxt()">ğŸ’¾ ä¿å­˜</button>
    </div>

    <h2>â‘¡ æ•´å½¢ãƒ»æ ¡é–²çµæœ</h2>
    <div style="margin-bottom: 10px;"><span id="charCount" class="counter-badge">æ–‡å­—æ•°: 0</span></div>
    <div id="output"></div>
</div>

<script>
    const OPT_KEYS = ['opt_percent','opt_ampersand','opt_bracket','opt_colon','opt_comma','opt_quote','opt_mark','opt_dash','opt_hyphen','opt_slash','opt_equal', 'opt_mark_space'];
    let lastSynced = {}; let masterWhitelist = [];

    window.onload = function() {
        document.getElementById('githubToken').value = localStorage.getItem('gh_token') || '';
        if(localStorage.getItem('gh_user')) document.getElementById('githubUser').value = localStorage.getItem('gh_user');
        if(localStorage.getItem('gh_repo')) document.getElementById('githubRepo').value = localStorage.getItem('gh_repo');
        OPT_KEYS.forEach(id => {
            const val = localStorage.getItem(id); if(val) document.getElementById(id).value = val;
            document.getElementById(id).addEventListener('change', saveSettings);
        });
        if(localStorage.getItem('theme') === 'dark') toggleDarkMode();
    };

    function saveSettings() {
        localStorage.setItem('gh_token', document.getElementById('githubToken').value);
        localStorage.setItem('gh_user', document.getElementById('githubUser').value);
        localStorage.setItem('gh_repo', document.getElementById('githubRepo').value);
        OPT_KEYS.forEach(id => localStorage.setItem(id, document.getElementById(id).value));
    }

    function toggleDarkMode() {
        const body = document.body; body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('modeBtn').innerText = isDark ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
    }

    function copyToClipboard() { const text = document.getElementById('output').innerText; if (!text) return; navigator.clipboard.writeText(text).then(() => alert("ã‚³ãƒ”ãƒ¼å®Œäº†ï¼")); }

    function checkUnsaved(id) {
        const current = document.getElementById(id).value.trim();
        const last = (lastSynced[id] || "").trim();
        const status = document.getElementById('status_' + id);
        if (last === "") { status.innerText = "â˜ï¸ æœªèª­è¾¼"; status.className = "list-status status-init"; }
        else if (current !== last) { status.innerText = "âš ï¸ æœªå…±æœ‰"; status.className = "list-status status-unsaved"; }
        else { status.innerText = "âœ… æœ€æ–°"; status.className = "list-status status-sync"; }
    }

    function onListInput() { checkUnsaved('whitelist'); masterWhitelist = document.getElementById('whitelist').value.split('\n'); }

    function filterList() {
        const query = document.getElementById('search_whitelist').value.toLowerCase();
        const textArea = document.getElementById('whitelist');
        if (query === "") { textArea.value = masterWhitelist.join('\n'); textArea.readOnly = false; textArea.style.opacity = "1"; }
        else { textArea.value = masterWhitelist.filter(line => line.toLowerCase().includes(query)).join('\n'); textArea.readOnly = true; textArea.style.opacity = "0.7"; }
    }

    function suggestRules() {
        const out = document.getElementById('output').innerText; if(!out) return;
        const matches = out.match(/[ã‚¡-ãƒ¶ãƒ¼]{3,}/g) || [];
        const rules = []; const seen = new Set();
        Array.from(new Set(matches)).sort().forEach(word => {
            if (word.endsWith('ãƒ¼')) {
                const base = word.slice(0, -1); if (base.length < 3) return;
                const rule = `${word}, ${base} > ${base}`; if (!seen.has(rule)) { rules.push(rule); seen.add(rule); }
            }
        });
        if (rules.length > 0) {
            currentSuggestions = rules; const panel = document.getElementById('assistPanel'); const listDiv = document.getElementById('assistList');
            listDiv.innerHTML = ""; rules.forEach((r, i) => { listDiv.innerHTML += `<div class="assist-item"><input type="checkbox" id="rule_${i}" checked> <label for="rule_${i}">${r}</label></div>`; });
            panel.style.display = 'block';
        }
    }

    function applySuggestions() {
        const area = document.getElementById('replaceList');
        currentSuggestions.forEach((rule, i) => { if (document.getElementById(`rule_${i}`).checked) area.value += (area.value ? '\n' : '') + rule; });
        document.getElementById('assistPanel').style.display = 'none'; checkUnsaved('replaceList');
    }

    async function syncList(fileName, elementId) {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        const textArea = document.getElementById(elementId);
        if(!token || !user || !repo) return;
        const url = `https://api.github.com/repos/${user}/${repo}/contents/${fileName}`;
        try {
            const res = await fetch(url, { headers: { "Authorization": `token ${token}` }, cache: "no-store" });
            if (res.ok) {
                const data = await res.json(); let remote = decodeURIComponent(escape(atob(data.content)));
                if (elementId === 'whitelist' || elementId === 'replaceList') {
                    const lines = (remote.includes(',') && !remote.includes('\n')) ? remote.split(',').map(s=>s.trim()) : remote.split('\n').map(s=>s.trim());
                    remote = Array.from(new Set(lines)).filter(s=>s!=="").sort((a,b)=>a.localeCompare(b,'ja')).join('\n');
                    if(elementId === 'whitelist') masterWhitelist = remote.split('\n');
                }
                if (textArea.value.trim() !== "" && textArea.value.trim() !== remote.trim()) {
                    if (confirm("GitHubã«ä¿å­˜ï¼ˆä¸Šæ›¸ãï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) {
                        const putRes = await fetch(url, { method: "PUT", headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                            body: JSON.stringify({ message: `Update ${fileName}`, content: btoa(unescape(encodeURIComponent(textArea.value))), sha: data.sha }) });
                        if(putRes.ok) { lastSynced[elementId] = textArea.value; checkUnsaved(elementId); alert("ä¿å­˜å®Œäº†"); return; }
                    }
                }
                textArea.value = remote; lastSynced[elementId] = remote; checkUnsaved(elementId); alert("èª­è¾¼å®Œäº†");
            }
        } catch (e) { alert("åŒæœŸã‚¨ãƒ©ãƒ¼"); }
    }

    // --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³ v28 ---
    function processText() {
        let text = document.getElementById('input').value;
        const isCompare = document.getElementById('compareMode').checked;
        const activeStyle = document.getElementById('activeStyle').value;
        const config = {}; OPT_KEYS.forEach(id => config[id] = document.getElementById(id).value);

        // 0. åˆæœŸæ­£è¦åŒ–
        text = text.replace(/\r\n/g, '\n').replace(/[\t\u00A0]/g, ' ').replace(/[ ã€€]+\n/g, '\n');

        // ã€ãƒã‚°ä¿®æ­£ã€‘å†’é ­ã®å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’ãƒãƒ¼ã‚«ãƒ¼ã§å®ˆã‚‹
        let hasStartSpace = text.startsWith('ã€€');
        if (hasStartSpace) text = '___S_Z_SP___' + text.slice(1);

        const protectedItems = [];
        // URLãƒ»æ™‚åˆ»ä¿è­·
        text = text.replace(/https?:\/\/[\w!\?\/+\-_~=;\.,\*&@#\$%\(\)'\[\]]+/g, (m) => {
            const p = `___P_URL_${protectedItems.length}___`; protectedItems.push({p, val: m}); return p;
        });
        text = text.replace(/\d{1,2}:\d{2}/g, (m) => {
            const p = `___P_TIME_${protectedItems.length}___`; protectedItems.push({p, val: m}); return p;
        });
        // æ®µè½ä¿è­·
        text = text.replace(/(^|\n)\s*ã€€/g, (m, p1) => p1 + '___P_ZPARA___').replace(/\n\n+/g, '___P_DPARA___');

        // 1. ä¿è­·ãƒªã‚¹ãƒˆ (1. ä¿è­·ãƒªã‚¹ãƒˆ)
        const whitelist = document.getElementById('whitelist').value.split('\n').map(s => s.trim()).filter(s => s !== "");
        whitelist.forEach((word, i) => {
            const noSpaceWord = word.replace(/\s+/g, '');
            const spacedRegex = new RegExp(noSpaceWord.split('').join('[\\s\\n]*'), 'gi');
            text = text.replace(spacedRegex, (match) => {
                if (match.includes('___P_')) return match;
                const hasNewline = match.includes('\n');
                let resultWord = (match.replace(/[\s\n]+/g, '').toLowerCase() === noSpaceWord.toLowerCase() && hasNewline) ? word : (match === word ? word : (isCompare ? `${match}ã€>${word}ã€‘` : word));
                const p = `___P_WL_${i}_${Math.random().toString(36).slice(-2)}___`;
                protectedItems.push({p, val: resultWord}); return p;
            });
        });

        // 2. åŸºæœ¬æƒé™¤ï¼ˆæ”¹è¡Œå‰Šé™¤ï¼‰
        text = text.replace(/\n/g, '');

        // 3. è‹±æ•°å­—1æ–‡å­—çµåˆ ï¼† æ—¥æœ¬èªå‘¨è¾ºã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤ï¼ˆâ€»ç½®æ›ã‚ˆã‚Šã€Œå‰ã€ã«å®Ÿè¡Œï¼ï¼‰
        let prev; do { prev = text; text = text.replace(/([a-zA-Z0-9.]) +([a-zA-Z0-9.])/g, (m, p1, p2) => (p1.length === 1 || p2.length === 1) ? p1 + p2 : p1 + " " + p2); } while (prev !== text);
        text = text.replace(/([^\x00-\x7F]) +/g, '$1').replace(/ +([^\x00-\x7F])/g, '$1').replace(/([ã€ã€‚ï¼Œ]) +/g, '$1');

        // 4. æ ¡é–²ç½®æ› (Symbols, Master, Style)
        const replaceWithDiff = (regex, target) => {
            text = text.replace(regex, (m) => (m.trim() === target) ? m : (isCompare ? `${m}ã€>${target}ã€‘` : target));
        };
        replaceWithDiff(/[ï¼…%]/g, config.opt_percent === 'zen' ? 'ï¼…' : '%');
        replaceWithDiff(/[ï¼†&]/g, config.opt_ampersand === 'zen' ? 'ï¼†' : '&');
        replaceWithDiff(/[ï¼!]/g, config.opt_mark === 'zen' ? 'ï¼' : '!');
        replaceWithDiff(/[ï¼Ÿ?]/g, config.opt_mark === 'zen' ? 'ï¼Ÿ' : '?');
        replaceWithDiff(/[ï¼š:]/g, config.opt_colon === 'zen' ? 'ï¼š' : ':');
        const tOpen = config.opt_bracket === 'zen' ? 'ï¼ˆ' : '('; const tClose = config.opt_bracket === 'zen' ? 'ï¼‰' : ')';
        text = text.replace(/[\(\)ï¼ˆï¼‰]/g, (m) => { const t = (m === '(' || m === 'ï¼ˆ') ? tOpen : tClose; return (m === t) ? m : (isCompare ? `${m}ã€>${t}ã€‘` : t); });
        if (config.opt_comma === 'comma') replaceWithDiff(/ã€/g, 'ï¼Œ'); else replaceWithDiff(/ï¼Œ/g, 'ã€');
        if (config.opt_mark_space !== 'keep') {
            const markSpaceChar = config.opt_mark_space === 'force' ? 'ã€€' : '';
            text = text.replace(/([ï¼ï¼Ÿ])([ ã€€]*)([^\nï¼‰ã€‰ã€ã€ã€‘ï¼½\}])/g, (match, m1, space, nextChar) => {
                if (space === markSpaceChar) return match;
                const target = m1 + markSpaceChar + nextChar; return isCompare ? `${match}ã€>${target}ã€‘` : target;
            });
        }
        text = text.replace(/ï¼/g, isCompare ? 'ï¼ã€>.ã€‘' : '.').replace(/\uFF5E/g, isCompare ? '\uFF5Eã€>\u301Cã€‘' : '\u301C');
        text = text.replace(/[ï¼-ï¼™ï½-ï½šï¼¡-ï¼º]/g, (s) => { const han = String.fromCharCode(s.charCodeAt(0) - 0xFEE0); return isCompare ? `${s}ã€>${han}ã€‘` : han; });

        if (activeStyle !== 'none') {
            let finalRules = [];
            document.getElementById('replaceList').value.split('\n').forEach(line => {
                const parts = line.split('>'); if (parts.length === 2) parts[0].split(',').forEach(c => finalRules.push({ from: c.trim(), to: parts[1].trim() }));
            });
            try {
                const presets = JSON.parse(document.getElementById('presetsJson').value || '{}');
                const styleData = presets[activeStyle] || {};
                for (let key in styleData) key.split(',').forEach(c => { finalRules = finalRules.filter(r => r.from !== c.trim()); finalRules.push({ from: c.trim(), to: styleData[key] }); });
            } catch(e) {}
            finalRules.sort((a, b) => b.from.length - a.from.length);
            const occurrenceMap = new Map();
            finalRules.forEach(rule => {
                if (!rule.from) return;
                const regex = new RegExp(`[ç±³ç‹¬ä»æ—¥è‹±éŸ“ä¸­]*${rule.from.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}`, 'g');
                text = text.replace(regex, (match) => {
                    if (match.includes('___P_')) return match;
                    const count = (occurrenceMap.get(rule.from) || 0) + 1; occurrenceMap.set(rule.from, count);
                    let targetTo = rule.to.includes('|') ? (count === 1 ? rule.to.split('|')[0].trim() : rule.to.split('|')[1].trim()) : rule.to;
                    return (match === targetTo) ? match : (isCompare ? `${match}ã€>${targetTo}ã€‘` : targetTo);
                });
            });
        }

        // 5. ä¿è­·è§£é™¤ ï¼† ä»•ä¸Šã’
        text = text.split('___P_ZPARA___').join('\n\nã€€').split('___P_DPARA___').join('\n\n');
        for (let i = protectedItems.length - 1; i >= 0; i--) { text = text.split(protectedItems[i].p).join(protectedItems[i].val); }
        text = text.replace(/\n{3,}/g, '\n\n').trim();
        if (hasStartSpace) text = 'ã€€' + text.replace(/^___S_Z_SP___/, '');

        if (isCompare) document.getElementById('output').innerHTML = text.replace(/ã€>(.*?)ã€‘/g, '<span class="diff-tag">ã€&gt;$1ã€‘</span>');
        else document.getElementById('output').innerText = text;
        
        let zenCount = 0; for (let i = 0; i < text.length; i++) {
            const c = text.charCodeAt(i); if ((c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c <= 0xff9f)) zenCount += 0.5; else zenCount += 1;
        }
        document.getElementById('charCount').innerText = `æ–‡å­—æ•°: ${text.length} | å…¨è§’æ›ç®—: ${Math.ceil(zenCount)}`;
    }
</script>
</body>
</html>
