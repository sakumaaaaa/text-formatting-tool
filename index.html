<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ±ºå®šç‰ˆ v11</title>
    <style>
        :root {
            --bg-color: #f4f7f9;
            --container-bg: #ffffff;
            --text-color: #333333;
            --border-color: #cccccc;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-purple: #6f42c1;
            --accent-red: #dc3545;
            --config-bg: #fff3cd;
            --list-bg: #e2eefd;
            --opt-bg: #f8f9fa;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --accent-blue: #3793ff;
            --config-bg: #3d3b30;
            --list-bg: #2a3544;
            --opt-bg: #3a3a3a;
        }

        body { font-family: sans-serif; max-width: 950px; margin: 20px auto; padding: 0 20px; background-color: var(--bg-color); color: var(--text-color); transition: 0.3s; line-height: 1.4; }
        .container { background: var(--container-bg); padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        h1 { font-size: 1.3rem; border-left: 5px solid var(--accent-blue); padding-left: 15px; margin-top: 0; margin-bottom: 20px; }
        
        textarea { width: 100%; height: 200px; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; font-size: 14px; background: var(--container-bg); color: var(--text-color); font-family: inherit; }
        
        .config-area { background: var(--config-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px; font-size: 0.8rem; border: 1px solid #ffeeba; }
        .whitelist-area { background: var(--list-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px; }
        
        .options-grid { background: var(--opt-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; font-size: 0.8rem; border: 1px solid var(--border-color); }
        .opt-item { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        body.dark-mode .opt-item { border-bottom: 1px solid #444; }
        .opt-item select { padding: 2px; font-size: 0.75rem; background: var(--container-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 3px; width: 100px; }

        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin: 15px 0; }
        button { padding: 12px; cursor: pointer; background: var(--accent-blue); color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        button:hover { opacity: 0.8; }
        
        .btn-sync { background: var(--accent-purple); }
        .btn-download { background: var(--accent-green); }
        .btn-clear { background: var(--accent-red); font-size: 11px; padding: 5px 10px; }
        .btn-mode { background: #666; font-size: 11px; padding: 5px 10px; }
        .btn-copy { background: #17a2b8; }

        #output { background: var(--container-bg); padding: 20px; border: 1px solid var(--border-color); border-radius: 4px; white-space: pre-wrap; min-height: 200px; margin-top: 10px; font-size: 14px; word-break: break-all; }
        .label-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
        .counter-area { font-size: 0.85rem; color: var(--text-color); background: var(--bg-color); padding: 5px 10px; border-radius: 4px; margin-top: 5px; display: inline-block; }
        .top-nav { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body class="light-mode">

<div class="container">
    <div class="top-nav">
        <button class="btn-mode" onclick="toggleDarkMode()" id="modeBtn">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
    
    <h1>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ±ºå®šç‰ˆ v11</h1>
    
    <details class="config-area">
        <summary>ğŸ”§ ãƒãƒ¼ãƒ åŒæœŸè¨­å®š</summary>
        <div style="margin-top:10px;">
            GitHubãƒˆãƒ¼ã‚¯ãƒ³: <input type="password" id="githubToken" oninput="saveSettings()" style="width:70%;"><br>
            ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <input type="text" id="githubUser" oninput="saveSettings()" value="sakumaaaaa">
            ãƒªãƒã‚¸ãƒˆãƒª: <input type="text" id="githubRepo" oninput="saveSettings()" value="text-formatting-tool">
        </div>
    </details>

    <div class="options-grid" id="optionsGrid">
        <div class="opt-item"><span>ï¼… (ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ)</span><select id="opt_percent"><option value="zen">å…¨è§’ ï¼…</option><option value="han">åŠè§’ %</option></select></div>
        <div class="opt-item"><span>ï¼† (ã‚¢ãƒ³ãƒ‘ã‚µãƒ³ãƒ‰)</span><select id="opt_ampersand"><option value="zen">å…¨è§’ ï¼†</option><option value="han">åŠè§’ &</option></select></div>
        <div class="opt-item"><span>ï¼ˆ ï¼‰(ã‚«ãƒƒã‚³)</span><select id="opt_bracket"><option value="zen">å…¨è§’ ï¼ˆ ï¼‰</option><option value="han">åŠè§’ ( )</option></select></div>
        <div class="opt-item"><span>ï¼š (ã‚³ãƒ­ãƒ³)</span><select id="opt_colon"><option value="zen">å…¨è§’ ï¼š</option><option value="han">åŠè§’ :</option></select></div>
        <div class="opt-item"><span>èª­ç‚¹ (ã€)</span><select id="opt_comma"><option value="ten">ãƒ†ãƒ³ ã€</option><option value="comma">ã‚«ãƒ³ãƒ ï¼Œ</option></select></div>
        <div class="opt-item"><span>å¼•ç”¨ç¬¦ ( " " ' ' )</span><select id="opt_quote"><option value="zen">å…¨è§’ â€œâ€ â€˜â€™</option><option value="han">åŠè§’ " " ' '</option></select></div>
        <div class="opt-item"><span>ï¼ ï¼Ÿ (æ„Ÿå˜†ãƒ»ç–‘å•)</span><select id="opt_mark"><option value="zen">å…¨è§’ ï¼ ï¼Ÿ</option><option value="han">åŠè§’ ! ?</option></select></div>
        <div class="opt-item"><span>â€• (ãƒ€ãƒ¼ã‚·)</span><select id="opt_dash"><option value="zen">å…¨è§’ â€•</option><option value="han">åŠè§’ -</option></select></div>
        <div class="opt-item"><span>- (ãƒã‚¤ãƒ•ãƒ³/ãƒã‚¤ãƒŠã‚¹)</span><select id="opt_hyphen"><option value="han">åŠè§’ -</option><option value="zen">å…¨è§’ ï¼</option></select></div>
        <div class="opt-item"><span>ï¼ (ã‚¹ãƒ©ãƒƒã‚·ãƒ¥)</span><select id="opt_slash"><option value="han">åŠè§’ /</option><option value="zen">å…¨è§’ ï¼</option></select></div>
        <div class="opt-item"><span>ï¼ ï¼ ï¼œ (ç­‰å·ä¸ç­‰å·)</span><select id="opt_equal"><option value="han">åŠè§’ = < ></option><option value="zen">å…¨è§’ ï¼ ï¼ ï¼œ</option></select></div>
        <div class="opt-item"><span>ï¼‹ (ãƒ—ãƒ©ã‚¹)</span><select id="opt_plus"><option value="han">åŠè§’ +</option><option value="zen">å…¨è§’ ï¼‹</option></select></div>
        <div class="opt-item"><span>ï¼Š (ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯)</span><select id="opt_asterisk"><option value="han">åŠè§’ *</option><option value="zen">å…¨è§’ ï¼Š</option></select></div>
    </div>

    <div class="whitelist-area">
        <label><strong>é™¤å¤–ãƒªã‚¹ãƒˆ</strong></label>
        <textarea id="whitelist" style="height: 50px; margin-top:5px;"></textarea>
        <div style="display: flex; gap: 10px; margin-top:10px;">
            <button class="btn-sync" onclick="syncFromGitHub()" style="flex:1;">â˜ï¸ èª­è¾¼</button>
            <button class="btn-sync" onclick="syncToGitHub()" style="flex:1;">â¬†ï¸ å…±æœ‰</button>
        </div>
    </div>

    <div class="label-row">â‘  å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ</div>
    <textarea id="input" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘..."></textarea>
    
    <div class="button-grid">
        <button onclick="processText()">âœ¨ æ•´å½¢ã‚’å®Ÿè¡Œ</button>
        <button class="btn-copy" onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        <button class="btn-download" onclick="downloadTxt()">ğŸ’¾ ä¿å­˜</button>
    </div>

    <div class="label-row">
        <span>â‘¡ æ•´å½¢çµæœ</span>
        <div id="charCounter" class="counter-area">æ–‡å­—æ•°: 0 | å…¨è§’æ›ç®—: 0.0</div>
    </div>
    <div id="output"></div>
</div>

<script>
    const FILE_PATH = 'common_list.txt';
    const OPT_KEYS = ['opt_percent', 'opt_ampersand', 'opt_bracket', 'opt_colon', 'opt_comma', 'opt_quote', 'opt_mark', 'opt_dash', 'opt_hyphen', 'opt_slash', 'opt_equal', 'opt_plus', 'opt_asterisk'];

    window.onload = function() {
        document.getElementById('githubToken').value = localStorage.getItem('gh_token') || '';
        if(localStorage.getItem('gh_user')) document.getElementById('githubUser').value = localStorage.getItem('gh_user');
        if(localStorage.getItem('gh_repo')) document.getElementById('githubRepo').value = localStorage.getItem('gh_repo');
        OPT_KEYS.forEach(id => {
            const val = localStorage.getItem(id);
            if(val) document.getElementById(id).value = val;
            document.getElementById(id).addEventListener('change', saveSettings);
        });
        if(localStorage.getItem('theme') === 'dark') toggleDarkMode();
    };

    function saveSettings() {
        localStorage.setItem('gh_token', document.getElementById('githubToken').value);
        localStorage.setItem('gh_user', document.getElementById('githubUser').value);
        localStorage.setItem('gh_repo', document.getElementById('githubRepo').value);
        OPT_KEYS.forEach(id => { localStorage.setItem(id, document.getElementById(id).value); });
    }

    function toggleDarkMode() {
        const body = document.body; body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('modeBtn').innerText = isDark ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
    }

    function clearAll() { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { document.getElementById('input').value = ""; document.getElementById('output').innerText = ""; updateCounter(""); } }

    function copyToClipboard() {
        const text = document.getElementById('output').innerText;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => { alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"); });
    }

    async function syncFromGitHub() {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        if(!user || !repo) return;
        try {
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}`;
            const headers = token ? { "Authorization": `token ${token}` } : {};
            const res = await fetch(url, { headers: headers, cache: "no-store" });
            if (res.ok) {
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                document.getElementById('whitelist').value = content;
                alert("èª­è¾¼å®Œäº†");
            }
        } catch (e) { alert("èª­è¾¼å¤±æ•—"); }
    }

    async function syncToGitHub() {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        const content = document.getElementById('whitelist').value;
        if (!token) { alert("ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™"); return; }
        try {
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}`;
            const getRes = await fetch(url, { headers: { "Authorization": `token ${token}` }, cache: "no-store" });
            const fileData = await getRes.json();
            const putRes = await fetch(url, {
                method: "PUT", headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: "Update common_list.txt", content: btoa(unescape(encodeURIComponent(content))), sha: fileData.sha })
            });
            if (putRes.ok) alert("å…±æœ‰æˆåŠŸï¼");
        } catch (e) { alert("å¤±æ•—ã—ã¾ã—ãŸ"); }
    }

    function updateCounter(text) {
        let total = text.length;
        let zenkakuCount = 0;
        for (let i = 0; i < text.length; i++) {
            const c = text.charCodeAt(i);
            if ((c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c <= 0xff9f)) zenkakuCount += 0.5;
            else zenkakuCount += 1;
        }
        document.getElementById('charCounter').innerText = `æ–‡å­—æ•°: ${total} | å…¨è§’æ›ç®—: ${Math.ceil(zenkakuCount)}`;
    }

    function processText() {
        let text = document.getElementById('input').value;
        const config = {};
        OPT_KEYS.forEach(id => config[id] = document.getElementById(id).value);

        text = text.replace(/\r\n/g, '\n').replace(/[\t\u00A0]/g, ' ').replace(/[ ã€€]+\n/g, '\n');

        const protectedItems = [];
        text = text.replace(/https?:\/\/[\w!\?\/+\-_~=;\.,\*&@#\$%\(\)'\[\]]+/g, (match) => {
            const p = `___URL_PROT_${protectedItems.length}___`;
            protectedItems.push({ p, original: match });
            return p;
        });
        text = text.replace(/\d{1,2}:\d{2}/g, (match) => {
            const p = `___TIME_PROT_${protectedItems.length}___`;
            protectedItems.push({ p, original: match });
            return p;
        });

        text = text.replace(/\n\s*ã€€/g, '___ZEN_PARA___').replace(/\n\n+/g, '___DBL_PARA___');
        text = text.replace(/[ï½¥ãƒ»]/g, 'ãƒ»').replace(/--+/g, 'â€•');

        text = text.replace(/[ï¼…%]/g, config.opt_percent === 'zen' ? 'ï¼…' : '%');
        text = text.replace(/[ï¼†&]/g, config.opt_ampersand === 'zen' ? 'ï¼†' : '&');
        text = text.replace(/[ï¼!]/g, config.opt_mark === 'zen' ? 'ï¼' : '!');
        text = text.replace(/[ï¼Ÿ?]/g, config.opt_mark === 'zen' ? 'ï¼Ÿ' : '?');
        text = text.replace(/[ï¼š:]/g, config.opt_colon === 'zen' ? ' ï¼š' : ':');
        
        if (config.opt_bracket === 'zen') text = text.replace(/[\(\)]/g, s => s === '(' ? 'ï¼ˆ' : 'ï¼‰');
        else text = text.replace(/[ï¼ˆï¼‰]/g, s => s === 'ï¼ˆ' ? '(' : ')');
        
        if (config.opt_comma === 'comma') text = text.replace(/ã€/g, 'ï¼Œ');
        else text = text.replace(/ï¼Œ/g, 'ã€');

        if (config.opt_quote === 'zen') {
            text = text.replace(/"([^"]*)"/g, 'â€œ$1â€').replace(/'([^']*)'/g, 'â€˜$1â€™');
        } else {
            text = text.replace(/[â€œâ€]/g, '"').replace(/[â€˜â€™]/g, "'");
        }

        text = text.replace(/[â€•â€”]/g, config.opt_dash === 'zen' ? 'â€•' : '-').replace(/[ï¼-]/g, config.opt_hyphen === 'zen' ? 'ï¼' : '-');
        text = text.replace(/[ï¼/]/g, config.opt_slash === 'zen' ? 'ï¼' : '/').replace(/[ï¼=]/g, config.opt_equal === 'zen' ? 'ï¼' : '=');
        text = text.replace(/[ï¼>]/g, config.opt_equal === 'zen' ? 'ï¼' : '>').replace(/[ï¼œ<]/g, config.opt_equal === 'zen' ? 'ï¼œ' : '<');
        text = text.replace(/[ï¼‹+]/g, config.opt_plus === 'zen' ? 'ï¼‹' : '+').replace(/[ï¼Š*]/g, config.opt_asterisk === 'zen' ? 'ï¼Š' : '*');

        text = text.replace(/ï¼/g, '.').replace(/\uFF5E/g, '\u301C');
        text = text.replace(/[ï¼-ï¼™ï½-ï½šï¼¡-ï¼º]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));

        text = text.replace(/\n/g, '');
        let prev;
        do {
            prev = text;
            text = text.replace(/([a-zA-Z0-9.])\s+([a-zA-Z0-9.])/g, (match, p1, p2) => {
                return (p1.length === 1 || p2.length === 1) ? p1 + p2 : p1 + " " + p2;
            });
        } while (prev !== text);

        text = text.replace(/([^\x00-\x7F]) +/g, '$1').replace(/ +([^\x00-\x7F])/g, '$1').replace(/([ã€ã€‚ï¼Œ]) +/g, '$1');
        text = text.split('___ZEN_PARA___').join('\n\nã€€').split('___DBL_PARA___').join('\n\n');

        protectedItems.forEach(item => { text = text.split(item.p).join(item.original); });

        const whitelistStr = document.getElementById('whitelist').value;
        const whitelist = whitelistStr.split(',').map(s => s.trim()).filter(s => s !== "");
        whitelist.forEach(word => {
            if (word.length === 0) return;
            const combinedWord = word.replace(/\s+/g, '');
            const escapedCombined = combinedWord.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            text = text.replace(new RegExp(escapedCombined, 'gi'), word);
        });

        text = text.replace(/\n{3,}/g, '\n\n');
        const finalResult = text.trim();
        document.getElementById('output').innerText = finalResult;
        updateCounter(finalResult);
    }

    function downloadTxt() {
        const text = document.getElementById('output').innerText;
        if (!text) return;
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'cleaned_text.txt';
        a.click();
    }
</script>
</body>
</html>