<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ ãƒãƒ¼ãƒ åŒæœŸç‰ˆ</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 20px auto; padding: 0 20px; background-color: #f4f7f9; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { font-size: 1.4rem; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .config-area { background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 15px; font-size: 0.8rem; border: 1px solid #ffeeba; }
        .whitelist-area { background: #e2eefd; padding: 15px; border-radius: 4px; margin-bottom: 15px; }
        .buttons { display: flex; gap: 10px; margin: 20px 0; }
        button { flex: 1; padding: 12px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .btn-sync { background: #6f42c1; } /* ç´«è‰²ï¼šåŒæœŸãƒœã‚¿ãƒ³ */
        .btn-download { background: #28a745; }
        #output { background: #fff; padding: 20px; border: 1px solid #ddd; white-space: pre-wrap; min-height: 150px; }
        input[type="password"] { width: 100%; padding: 5px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ (ãƒãƒ¼ãƒ åŒæœŸç‰ˆ)</h1>
    
    <!-- è¨­å®šã‚¨ãƒªã‚¢ï¼šãƒˆãƒ¼ã‚¯ãƒ³ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã ã‘ãŒåŒæœŸã§ãã‚‹ -->
    <details class="config-area">
        <summary>ğŸ”§ ãƒãƒ¼ãƒ åŒæœŸè¨­å®šï¼ˆç®¡ç†è€…ãƒ»ç·¨é›†è€…ç”¨ï¼‰</summary>
        <p>GitHubã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        <input type="password" id="githubToken" oninput="saveSettings()" placeholder="github_pat_...">
        <p>GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å: <input type="text" id="githubUser" oninput="saveSettings()" placeholder="sakumaaaaa"></p>
        <p>ãƒªãƒã‚¸ãƒˆãƒªå: <input type="text" id="githubRepo" oninput="saveSettings()" placeholder="text-formatting-tool"></p>
    </details>

    <div class="whitelist-area">
        <label><strong>é™¤å¤–ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</strong></label>
        <textarea id="whitelist" placeholder="GaN HEMT, Power MOSFET"></textarea>
        <div style="display: flex; gap: 10px; margin-top:10px;">
            <button class="btn-sync" onclick="syncFromGitHub()">â˜ï¸ ãƒãƒ¼ãƒ ã®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
            <button class="btn-sync" onclick="syncToGitHub()">â¬†ï¸ ä»Šã®ãƒªã‚¹ãƒˆã‚’å…¨å“¡ã«å…±æœ‰ã™ã‚‹</button>
        </div>
    </div>

    <label><strong>â‘  å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ</strong></label>
    <textarea id="input" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
    
    <div class="buttons">
        <button onclick="processText()">âœ¨ æ•´å½¢ã‚’å®Ÿè¡Œ</button>
        <button class="btn-download" onclick="downloadTxt()">ğŸ’¾ .txtä¿å­˜</button>
    </div>

    <label><strong>â‘¡ æ•´å½¢çµæœ</strong></label>
    <div id="output"></div>
</div>

<script>
    const FILE_PATH = 'common_list.txt';

    // èª­ã¿è¾¼ã¿
    window.onload = function() {
        document.getElementById('githubToken').value = localStorage.getItem('gh_token') || '';
        document.getElementById('githubUser').value = localStorage.getItem('gh_user') || '';
        document.getElementById('githubRepo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('whitelist').value = localStorage.getItem('myTextToolWhitelist') || '';
        syncFromGitHub(); // èµ·å‹•æ™‚ã«è‡ªå‹•ã§èª­ã¿è¾¼ã¿
    };

    function saveSettings() {
        localStorage.setItem('gh_token', document.getElementById('githubToken').value);
        localStorage.setItem('gh_user', document.getElementById('githubUser').value);
        localStorage.setItem('gh_repo', document.getElementById('githubRepo').value);
    }

    // GitHubã‹ã‚‰ãƒªã‚¹ãƒˆã‚’å–å¾—
    async function syncFromGitHub() {
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        if(!user || !repo) return;

        try {
            const res = await fetch(`https://raw.githubusercontent.com/${user}/${repo}/main/${FILE_PATH}?t=${Date.now()}`);
            if (res.ok) {
                const text = await res.text();
                document.getElementById('whitelist').value = text;
                localStorage.setItem('myTextToolWhitelist', text);
                console.log("åŒæœŸå®Œäº†");
            }
        } catch (e) { alert("èª­ã¿è¾¼ã¿å¤±æ•—"); }
    }

    // GitHubã¸ãƒªã‚¹ãƒˆã‚’æ›¸ãè¾¼ã¿
    async function syncToGitHub() {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        const content = document.getElementById('whitelist').value;

        if (!token) { alert("ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„"); return; }

        try {
            // 1. ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³IDï¼‰ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}`;
            const getRes = await fetch(url, {
                headers: { "Authorization": `token ${token}` }
            });
            const fileData = await getRes.json();
            const sha = fileData.sha;

            // 2. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
            const putRes = await fetch(url, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    message: "Update common_list.txt via Web App",
                    content: btoa(unescape(encodeURIComponent(content))), // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                    sha: sha
                })
            });

            if (putRes.ok) {
                alert("ãƒãƒ¼ãƒ å…¨å“¡ã«å…±æœ‰ã—ã¾ã—ãŸï¼");
            } else {
                alert("å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    }

    // æ•´å½¢ãƒ­ã‚¸ãƒƒã‚¯ (å‰å›ã¨åŒã˜)
    function processText() {
        let text = document.getElementById('input').value;
        text = text.replace(/[\u3000\t]/g, ' ');
        const whitelistStr = document.getElementById('whitelist').value;
        const whitelist = whitelistStr.split(',').map(s => s.trim()).filter(s => s !== "");
        const placeholders = [];
        whitelist.forEach((word, index) => {
            if (word.length === 0) return;
            const p = `__SAFE${index}__`;
            placeholders.push({ placeholder: p, original: word });
            const escapedWord = word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&').replace(/\s+/g, '\\s+');
            text = text.replace(new RegExp(escapedWord, 'gi'), p);
        });
        text = text.replace(/([^\n])\n([^\n])/g, '$1$2');
        let prev;
        do {
            prev = text;
            text = text.replace(/([a-zA-Z0-9])\s+([a-zA-Z0-9])/g, (match, p1, p2) => {
                return (p1.length === 1 || p2.length === 1) ? p1 + p2 : p1 + " " + p2;
            });
        } while (prev !== text);
        text = text.replace(/([^\x00-\x7F])\s+/g, '$1');
        text = text.replace(/\s+([^\x00-\x7F])/g, '$1');
        placeholders.forEach(item => { text = text.split(item.placeholder).join(item.original); });
        text = text.replace(/\n{3,}/g, '\n\n');
        document.getElementById('output').innerText = text.trim();
    }

    function downloadTxt() {
        const text = document.getElementById('output').innerText;
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'cleaned_text.txt';
        a.click();
    }
</script>

</body>
</html>