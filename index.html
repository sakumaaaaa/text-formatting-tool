<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ±ºå®šç‰ˆ v5</title>
    <style>
        :root {
            --bg-color: #f4f7f9; --container-bg: #ffffff; --text-color: #333333; --border-color: #cccccc;
            --accent-blue: #007bff; --accent-green: #28a745; --accent-purple: #6f42c1; --accent-red: #dc3545;
            --config-bg: #fff3cd; --list-bg: #e2eefd;
        }
        body.dark-mode {
            --bg-color: #1a1a1a; --container-bg: #2d2d2d; --text-color: #e0e0e0; --border-color: #444444;
            --accent-blue: #3793ff; --config-bg: #3d3b30; --list-bg: #2a3544;
        }
        body { font-family: sans-serif; max-width: 900px; margin: 20px auto; padding: 0 20px; background-color: var(--bg-color); color: var(--text-color); transition: 0.3s; line-height: 1.6; }
        .container { background: var(--container-bg); padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        h1 { font-size: 1.3rem; border-left: 5px solid var(--accent-blue); padding-left: 15px; margin-top: 0; margin-bottom: 20px; }
        textarea { width: 100%; height: 180px; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; font-size: 14px; background: var(--container-bg); color: var(--text-color); font-family: inherit; }
        .config-area { background: var(--config-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px; font-size: 0.8rem; border: 1px solid #ffeeba; }
        .whitelist-area { background: var(--list-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin: 15px 0; }
        button { padding: 12px; cursor: pointer; background: var(--accent-blue); color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        button:hover { opacity: 0.8; }
        .btn-sync { background: var(--accent-purple); }
        .btn-download { background: var(--accent-green); }
        .btn-clear { background: var(--accent-red); font-size: 11px; padding: 5px 10px; }
        .btn-mode { background: #666; font-size: 11px; padding: 5px 10px; }
        .btn-copy { background: #17a2b8; }
        #output { background: var(--container-bg); padding: 20px; border: 1px solid var(--border-color); border-radius: 4px; white-space: pre-wrap; min-height: 180px; margin-top: 10px; font-size: 14px; word-break: break-all; }
        .label-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
        .top-nav { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body class="light-mode">
<div class="container">
    <div class="top-nav">
        <button class="btn-mode" onclick="toggleDarkMode()" id="modeBtn">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
    </div>
    <h1>ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãã‚“ æ±ºå®šç‰ˆ v5</h1>
    <details class="config-area">
        <summary>ğŸ”§ ãƒãƒ¼ãƒ åŒæœŸè¨­å®š</summary>
        <div style="margin-top:10px;">
            GitHubãƒˆãƒ¼ã‚¯ãƒ³: <input type="password" id="githubToken" oninput="saveSettings()" style="width:70%;" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘"><br>
            ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <input type="text" id="githubUser" oninput="saveSettings()" value="sakumaaaaa">
            ãƒªãƒã‚¸ãƒˆãƒª: <input type="text" id="githubRepo" oninput="saveSettings()" value="text-formatting-tool">
        </div>
    </details>
    <div class="whitelist-area">
        <label><strong>é™¤å¤–ãƒªã‚¹ãƒˆï¼ˆ[èª­è¾¼] ãƒœã‚¿ãƒ³ã§å–å¾—ï¼‰</strong></label>
        <textarea id="whitelist" style="height: 50px; margin-top:5px;"></textarea>
        <div style="display: flex; gap: 10px; margin-top:10px;">
            <button class="btn-sync" onclick="syncFromGitHub()" style="flex:1;">â˜ï¸ èª­è¾¼</button>
            <button class="btn-sync" onclick="syncToGitHub()" style="flex:1;">â¬†ï¸ å…±æœ‰</button>
        </div>
    </div>
    <div class="label-row"><span>â‘  å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ</span></div>
    <textarea id="input" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘..."></textarea>
    <div class="button-grid">
        <button onclick="processText()">âœ¨ æ•´å½¢ã‚’å®Ÿè¡Œ</button>
        <button class="btn-copy" onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        <button class="btn-download" onclick="downloadTxt()">ğŸ’¾ ä¿å­˜</button>
    </div>
    <div class="label-row">â‘¡ æ•´å½¢çµæœ</div>
    <div id="output"></div>
</div>

<script>
    const FILE_PATH = 'common_list.txt';
    window.onload = function() {
        document.getElementById('githubToken').value = localStorage.getItem('gh_token') || '';
        if(localStorage.getItem('gh_user')) document.getElementById('githubUser').value = localStorage.getItem('gh_user');
        if(localStorage.getItem('gh_repo')) document.getElementById('githubRepo').value = localStorage.getItem('gh_repo');
        if(localStorage.getItem('theme') === 'dark') toggleDarkMode();
    };
    function saveSettings() {
        localStorage.setItem('gh_token', document.getElementById('githubToken').value);
        localStorage.setItem('gh_user', document.getElementById('githubUser').value);
        localStorage.setItem('gh_repo', document.getElementById('githubRepo').value);
    }
    function toggleDarkMode() {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('modeBtn').innerText = isDark ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
    }
    function clearAll() {
        if(confirm("ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            document.getElementById('input').value = "";
            document.getElementById('output').innerText = "";
        }
    }
    function copyToClipboard() {
        const text = document.getElementById('output').innerText;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => { alert("ã‚³ãƒ”ãƒ¼å®Œäº†ï¼"); });
    }

    async function syncFromGitHub() {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        if(!user || !repo) return;
        try {
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}`;
            const headers = token ? { "Authorization": `token ${token}` } : {};
            const res = await fetch(url, { headers: headers, cache: "no-store" });
            if (res.ok) {
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                document.getElementById('whitelist').value = content;
                alert("æœ€æ–°ã®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
            } else { alert("å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚„ãƒªãƒã‚¸ãƒˆãƒªåã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
        } catch (e) { alert("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼"); }
    }

    async function syncToGitHub() {
        const token = document.getElementById('githubToken').value;
        const user = document.getElementById('githubUser').value;
        const repo = document.getElementById('githubRepo').value;
        const content = document.getElementById('whitelist').value;
        if (!token) { alert("å…±æœ‰ã«ã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚"); return; }
        try {
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}`;
            const getRes = await fetch(url, { headers: { "Authorization": `token ${token}` }, cache: "no-store" });
            const fileData = await getRes.json();
            const putRes = await fetch(url, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: "Update common_list.txt",
                    content: btoa(unescape(encodeURIComponent(content))),
                    sha: fileData.sha
                })
            });
            if (putRes.ok) alert("GitHubã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
    }

    function processText() {
        let text = document.getElementById('input').value;

        // 0. æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã®çµ±ä¸€ã¨ã€ã‚¿ãƒ–ç­‰ã®ç‰¹æ®Šç©ºç™½ã®æ­£è¦åŒ–
        text = text.replace(/\r\n/g, '\n').replace(/[\t\u00A0]/g, ' ');

        // --- é™¤å¤–ãƒªã‚¹ãƒˆã®ã€Œè¶…ãƒ»å¼·åŠ›ã€ä¿è­·ï¼ˆFuzzy Matchingï¼‰ ---
        // æ„å›³ï¼šãƒªã‚¹ãƒˆã«ã€ŒInfineon Technologiesã€ãŒã‚ã‚Œã°ã€å…¥åŠ›ãŒã€ŒInfi neonã€ã§ã‚‚ä¿è­·ã—ã¦ä¿®æ­£ã™ã‚‹
        const whitelistStr = document.getElementById('whitelist').value;
        const whitelist = whitelistStr.split(',').map(s => s.trim()).filter(s => s !== "");
        const placeholders = [];
        whitelist.forEach((word, index) => {
            if (word.length === 0) return;
            const p = `__SAFE${index}__`;
            placeholders.push({ placeholder: p, original: word });
            // ãƒªã‚¹ãƒˆå˜èªã®å„æ–‡å­—ã®é–“ã«ã€Œæ”¹è¡Œã‚„ã‚¹ãƒšãƒ¼ã‚¹ã€ãŒæŒŸã¾ã£ã¦ã„ã¦ã‚‚ãƒãƒƒãƒã•ã›ã‚‹æ­£è¦è¡¨ç¾
            const fuzzyPattern = word.split('').map(c => {
                const escaped = c.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                return escaped + "[\\s\\u3000]*";
            }).join('');
            text = text.replace(new RegExp(fuzzyPattern, 'gi'), p);
        });

        // â‘¤ æ®µè½ã®å‡¦ç†ï¼šæ”¹è¡Œï¼‹å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆPDFã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼‰ã‚’ä¿è­·
        // PDFã‚³ãƒ”ãƒ¼æ™‚ã«æ”¹è¡Œå‰ã«ã‚¹ãƒšãƒ¼ã‚¹ãŒå…¥ã‚‹ã®ã‚’è€ƒæ…®ã— \s*\n\s*ã€€ ã‚’æ¤œç´¢
        text = text.replace(/\s*\n\s*ã€€/g, '___PARA_BREAK___');

        // â‘ â‘¡â‘¢â‘£ åŸºæœ¬ç½®æ›
        text = text.replace(/\(/g, 'ï¼ˆ').replace(/\)/g, 'ï¼‰');
        text = text.replace(/\uFF5E/g, '\u301C');
        text = text.replace(/[ï¼-ï¼™ï½-ï½šï¼¡-ï¼º]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
        });

        // æ–‡ä¸­ã®ä¸è¦ãªæ”¹è¡Œã‚’çµåˆ
        text = text.replace(/([^\n])\n([^\n])/g, '$1$2');

        // ä¿è­·ã—ãŸæ®µè½ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹é–‹å§‹ï¼‰ã‚’å¾©å…ƒ
        text = text.replace(/___PARA_BREAK___/g, '\n\nã€€');

        // --- è‹±æ•°å­—ãƒãƒ©ãƒãƒ©çµåˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰ ---
        // æ„å›³ï¼š1 9 7 8 ã¯ç¹‹ããŒã€Infineon Technologies ã¯ç¹‹ãŒãªã„
        // ãƒ«ãƒ¼ãƒ«ï¼šã‚¹ãƒšãƒ¼ã‚¹ã®ã€Œå‰å¾Œä¸¡æ–¹ã€ãŒã€å˜ç‹¬ã®1æ–‡å­—ï¼ˆã¾ãŸã¯ãƒ‰ãƒƒãƒˆç­‰ï¼‰ã®å ´åˆã®ã¿çµåˆ
        let prev;
        do {
            prev = text;
            text = text.replace(/(?<![a-zA-Z0-9.])([a-zA-Z0-9.])\s+([a-zA-Z0-9.])(?![a-zA-Z0-9.])/g, '$1$2');
        } while (prev !== text);

        // æ—¥æœ¬èªå‘¨è¾ºã®ä¸è¦ãªã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
        text = text.replace(/([^\x00-\x7F])\s+/g, '$1');
        text = text.replace(/\s+([^\x00-\x7F])/g, '$1');

        // é™¤å¤–ãƒªã‚¹ãƒˆã®å¾©å…ƒ
        placeholders.forEach(item => {
            text = text.split(item.placeholder).join(item.original);
        });

        text = text.replace(/\n{3,}/g, '\n\n');
        document.getElementById('output').innerText = text.trim();
    }

    function downloadTxt() {
        const text = document.getElementById('output').innerText;
        if (!text) return;
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'cleaned_text.txt';
        a.click();
    }
</script>
</body>
</html>